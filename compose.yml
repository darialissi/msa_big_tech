services:

  auth:
    container_name: auth_service
    build:
      context: ./auth
    env_file:
      - ./auth/.env
    ports:
      - "8083:50053"
    networks:
      - app-network
    depends_on:
      auth_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:50053"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  auth_postgres:
    image: postgres:latest
    container_name: auth_postgres
    env_file:
      - ./auth/.env
    ports:
      - 5433:5432
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  chat:
    container_name: chat_service
    build:
      context: ./chat
    env_file:
      - ./chat/.env
    ports:
      - "8084:50054"
    networks:
      - app-network
    depends_on:
      chat_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:50054"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  chat_postgres:
    image: postgres:latest
    container_name: chat_postgres
    env_file:
      - ./chat/.env
    ports:
      - 5434:5432
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
      
  social:
    container_name: social_service
    build:
      context: ./social
    env_file:
      - ./social/.env
    ports:
      - "8085:50055"
    networks:
      - app-network
    depends_on:
      social_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:50055"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  social_postgres:
    image: postgres:latest
    container_name: social_postgres
    env_file:
      - ./social/.env
    ports:
      - 5435:5432
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  users:
    container_name: users_service
    build:
      context: ./users
    env_file:
      - ./users/.env
    ports:
      - "8086:50056"
    networks:
      - app-network
    depends_on:
      users_postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:50056"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  users_postgres:
    image: postgres:latest
    container_name: users_postgres
    env_file:
      - ./users/.env
    ports:
      - 5436:5432
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  gateway:
    container_name: gateway_service
    build:
      context: ./gateway
    ports:
      - "8087:50057"
    networks:
      - app-network
    depends_on:
      - auth
      - chat
      - social
      - users


# Определяем общую сеть
networks:
  app-network:
    driver: bridge
    name: app-network